<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" type="text/css" th:href="@{/bootstrap.min.css}">
    <!-- sbb CSS -->
    <link rel="stylesheet" type="text/css" th:href="@{/style.css}">
    <title>Hello, Todolist!</title>
</head>
<body>
    <!-- 네이게이션바 -->
    <nav th:replace="~{navbar :: navbarFragment}"></nav>
    <div class="container my-3">
        <style>
            .modal {
                position: absolute;
                width: 100%;
                height: 100%;
                background: black;
                top: 0;
                left: 0;
                display: none;
            }
			
			.completed-task {
			    text-decoration: line-through;
			    color: gray;
			}
        </style>

	<h3>오늘 할 일☑️</h3> 
	<h3 th:text="|${formattedDateTime} ${dayOfWeekInKorea}|"></h3>	
	 
    <table class="table">
        <thead class="table-dark">
        <tr>
			<th>번호</th>
			<th>완료</th>
            <th>할 일</th>
			<th>등록일</th>
			<th>삭제/수정</th>

        </tr>
        </thead>
        <tbody>
        <tr th:each="todoentity, loop : ${paging}">
            <!--<td th:text="${todoentity.id}"></td>-->
			<td th:text="${paging.getTotalElements - (paging.number * paging.size) - loop.index}"></td>
			<td>
				<!--<button id="complete-btn" th:onclick="completeItem([[${todoentity.id}]])">완료</button>-->
				<div class="form-check form-switch">
				    <input class="form-check-input" type="checkbox" role="switch" 
				           th:checked="${todoentity.completed}" 
				           th:id="'switch-' + ${todoentity.id}" 
				           th:onchange="completeItem([[${todoentity.id}]], this.checked)">
				</div>
				
			</td>
            <td>
				<a th:href="@{|/todo/detail/${todoentity.id}|}" 
				th:text="${todoentity.content}"
				th:classappend="${todoentity.completed} ? 'completed-task' : ''"></a>
				<span class="text-danger small ms-2"
				      th:if="${todoentity.memo != null and #strings.length(todoentity.memo) > 0}"
				      th:text="'memo'">
				</span>
			</td> 
			<td th:text="${todoentity.createDate}"></td>
			
			<td>
				<button id="delete-btn" th:onclick="deleteItem([[${todoentity.id}]])">삭제</button>
				<button id="reviseBtn" th:onclick="openModal([[${todoentity.id}]])">수정</button>
			</td>
        </tr>
        </tbody>
    </table>
	
	<form th:action="@{/todo/create}" method="post">
	    <input name="content" placeholder="할 일을 추가해보세요!"/>
	    <button>등록</button>
	</form>
	
	<!-- 페이징처리 시작 -->
    <div th:if="${!paging.isEmpty()}">
        <ul class="pagination justify-content-center">
            <li class="page-item" th:classappend="${!paging.hasPrevious} ? 'disabled'">
                <a class="page-link"
                    th:href="@{|?page=${paging.number-1}|}">
                    <span>이전</span>
                </a>
            </li>
            <li th:each="page: ${#numbers.sequence(0, paging.totalPages-1)}"
				th:if="${page >= paging.number-5 and page <= paging.number+5}"
                th:classappend="${page == paging.number} ? 'active'" 
                class="page-item">
                <a th:text="${page}" class="page-link" th:href="@{|?page=${page}|}"></a>
            </li>
            <li class="page-item" th:classappend="${!paging.hasNext} ? 'disabled'">
                <a class="page-link" th:href="@{|?page=${paging.number+1}|}">
                    <span>다음</span>
                </a>
            </li>
        </ul>
    </div>
    <!-- 페이징처리 끝 -->
	</div>
	<div class="modal">
	    <div class="modal_content">
	        <input id="revise" placeholder="내용을 수정해주세요"/>
	        <button type="submit" id="completeBtn" onclick="reviseItem()">완료</button>
	    </div>
	</div>
	

<!-- Bootstrap JS -->
<script th:src="@{/bootstrap.min.js}"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script>

let value = "";

function deleteItem(id){
    console.log(id)
    const url = "/todo/delete/"+id
    $.ajax({
        type:'delete',
        url:url,
        contentType:'application/json; charset=utf-8'
        }).done(function() {
        alert('할 일이 삭제되었습니다.');
        window.location.href = '/todo/list';
        }).fail(function (error){
        alert(JSON.stringify(error));
    });
}

function openModal(id){
    value = id
    $(".modal").fadeIn();
}

function reviseItem(){

    var id = value;
    console.log(id)
    var contentWritten = document.getElementById("complete").value;
    var updateContent = contentWritten;
    console.log(updateContent)
    const url = "/todo/update/"+id;
     $.ajax({
        type:'put',
        url:url,
        contentType:'application/json; charset=utf-8',
        data: updateContent,
        }).done(function() {
        alert('할 일이 수정되었습니다.');
        window.location.href = '/todo/list';
        }).fail(function (error){
        alert(JSON.stringify(error));
        });

     $(".modal").fadeOut();
}

function completeItem(id, isChecked) {
    console.log(`Item ID : ${id}, Checked: ${isChecked}`);
    const url = `/todo/complete/${id}`;
	
	if(isChecked) {
		$.ajax({
	        type:'put',
	        url:url,
	        contentType:'application/json; charset=utf-8'
	    }).done(function() {
	    	alert('할 일을 완료했습니다!');
	        window.location.href = '/todo/list';
	    }).fail(function (error){
	        alert(JSON.stringify(error));
        });	
	} else {
		$.ajax({
		    type:'put',
		    url:url,
		    contentType:'application/json; charset=utf-8'
		}).done(function() {
			alert('할 일의 완료를 취소했습니다.');
		    window.location.href = '/todo/list';
		}).fail(function (error){
		    alert(JSON.stringify(error));
		});
		
	}
     
}

</script>
</html>