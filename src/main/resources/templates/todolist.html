<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" type="text/css" th:href="@{/bootstrap.min.css}">
    <!-- sbb CSS -->
    <link rel="stylesheet" type="text/css" th:href="@{/style.css}">
<!--
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
	<script type="text/javascript">
		jQuery(document).ready(function () {
		    function initializeSortable() {
		        jQuery("table > tbody").sortable({
		            start: function (event, ui) {
		                ui.item.addClass("selected");
		            },
		            stop: function (event, ui) {
		                ui.item.removeClass("selected");
		            },
		            update: function (event, ui) {
		                // ìˆœì„œ ë³€ê²½ ì‹œ í˜¸ì¶œ
		                const updatedOrder = [];
		                jQuery("table > tbody > tr").each(function (index, element) {
		                    const id = jQuery(element).data("id"); // ê° í–‰ì˜ ë°ì´í„° ID
		                    updatedOrder.push({ id: id, orderIndex: index });
		                });

		                // ì„œë²„ë¡œ ì—…ë°ì´íŠ¸ ìš”ì²­
		                $.ajax({
		                    type: "POST",
		                    url: "/todo/updateOrder", // ìˆœì„œ ì—…ë°ì´íŠ¸ API
		                    contentType: "application/json",
		                    data: JSON.stringify(updatedOrder), // ë³€ê²½ëœ ìˆœì„œ ì „ì†¡
		                    success: function () {
		                        console.log("ìˆœì„œê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!");
		                    },
		                    error: function (error) {
		                        console.error("ìˆœì„œ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", error);
		                    },
		                });
		            },
		        });
		    }

		    initializeSortable();
		});
	</script>
-->
    <title>Hello, Todolist!</title>
</head>
<body>
    <!-- ë„¤ì´ê²Œì´ì…˜ë°” -->
    <nav th:replace="~{navbar :: navbarFragment}"></nav>
    <div class="container my-3">
        <style>
			.completed-task {
			    text-decoration: line-through;
			    color: gray;
			}
			
        </style>
		

	<!--<h3>ì˜¤ëŠ˜ í•  ì¼â˜‘ï¸</h3>--> 
	<h3 th:text="|${formattedDateTime} ${dayOfWeekInKorea}|"></h3>
	<br>
		
	<form th:action="@{/todo/create}" method="post">
	    <input name="content" placeholder="í•  ì¼ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!"/>
	    <button class="btn btn-dark">New Task</button>
	</form>
	<br>
	 
    <table class="table" id="sortable">
        <thead class="table-light">
        <tr>
			<th>No.</th>
			<th>Complete</th>
            <th>Task</th>
			<th>Added On</th>
			<th>Edit/Delete</th>
			<th>Star</th>

        </tr>
        </thead>
        <tbody>
        <tr th:each="todoentity, loop : ${paging}">
            <!--<td th:text="${todoentity.id}"></td>-->
			<!-- ë²ˆí˜¸ -->
			<td th:text="${paging.getTotalElements - (paging.number * paging.size) - loop.index}"></td>
			<!-- ë²ˆí˜¸ ë -->
			<!-- ì™„ë£Œ ìŠ¤ìœ„ì¹˜ -->
			<td>
				<!--<button id="complete-btn" th:onclick="completeItem([[${todoentity.id}]])">ì™„ë£Œ</button>-->
				<div class="form-check form-switch">
				    <input class="form-check-input" type="checkbox" role="switch" 
				           th:checked="${todoentity.completed}" 
				           th:id="'switch-' + ${todoentity.id}" 
				           th:onchange="completeItem([[${todoentity.id}]], this.checked)">
				</div>
				
			</td>
			<!-- ì™„ë£Œ ìŠ¤ìœ„ì¹˜ ë -->
			<!-- í•  ì¼ -->
            <td>
				<a th:href="@{|/todo/detail/${todoentity.id}|}" 
				th:text="${todoentity.content}"
				th:classappend="${todoentity.completed} ? 'completed-task' : ''"></a>
				<span class="text-danger small ms-2"
				      th:if="${todoentity.memo != null and #strings.length(todoentity.memo) > 0}"
				      th:text="'memo'">
				</span>
			</td> 
			<!-- í•  ì¼ ë -->
			<!-- ë“±ë¡ì¼ -->
			<td th:text="${todoentity.createDate}"></td>
			<!-- ë“±ë¡ì¼ ë -->
			
			<td>
				<!-- ìˆ˜ì • ë²„íŠ¼ -->
				<button type="button" class="btn btn-dark" 
				        data-bs-toggle="modal" 
				        data-bs-target="#reviseModal" 
				        th:onclick="openModal([[${todoentity.id}]])">
				    Edit
				</button>
				<!-- ìˆ˜ì • ë²„íŠ¼ ë -->
				
				<!-- ìˆ˜ì • ëª¨ë‹¬ -->
				<div class="modal fade" id="reviseModal" tabindex="-1" aria-labelledby="reviseModalLabel" aria-hidden="true">
				  <div class="modal-dialog">
				    <div class="modal-content">
				      <div class="modal-header">
				        <h1 class="modal-title fs-5" id="reviseModalLabel">Task Edit</h1>
				        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				      </div>
				      <div class="modal-body">
				        <input id="reviseInput" class="form-control" placeholder="ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" />
				      </div>
				      <div class="modal-footer">
				        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">close</button>
				        <button type="button" class="btn btn-primary" onclick="reviseItem()">save</button>
				      </div>
				    </div>
				  </div>
				</div>
				<!-- ìˆ˜ì • ëª¨ë‹¬ ë -->
				<button id="delete-btn" class="btn btn-dark" th:onclick="deleteItem([[${todoentity.id}]])">Delete</button>
			</td>
			<td>
			    <button id="prior-btn" class="btn btn-light" 
			            th:onclick="togglePriority([[${todoentity.id}]])"
			            th:classappend="${todoentity.priority} ? 'btn-danger' : 'btn-light'">
			        <span th:text="${todoentity.priority} ? 'â­' : ' '"></span>
					<!--<span th:text="${todoentity.priority} ? 'ğŸ“Œ' : ''"></span>-->
			    </button>
			</td>
        </tr>
        </tbody>
    </table>
	
	<!-- í˜ì´ì§•ì²˜ë¦¬ ì‹œì‘ -->
    <div th:if="${!paging.isEmpty()}">
        <ul class="pagination justify-content-center">
            <li class="page-item" th:classappend="${!paging.hasPrevious} ? 'disabled'">
                <a class="page-link"
                    th:href="@{|?page=${paging.number-1}|}">
                    <span>ì´ì „</span>
                </a>
            </li>
            <li th:each="page: ${#numbers.sequence(0, paging.totalPages-1)}"
				th:if="${page >= paging.number-5 and page <= paging.number+5}"
                th:classappend="${page == paging.number} ? 'active'" 
                class="page-item">
                <a th:text="${page}" class="page-link" th:href="@{|?page=${page}|}"></a>
            </li>
            <li class="page-item" th:classappend="${!paging.hasNext} ? 'disabled'">
                <a class="page-link" th:href="@{|?page=${paging.number+1}|}">
                    <span>ë‹¤ìŒ</span>
                </a>
            </li>
        </ul>
    </div>
    <!-- í˜ì´ì§•ì²˜ë¦¬ ë -->
	</div>
	<!--
	<div class="modal">
	    <div class="modal_content">
	        <input id="revise" placeholder="ë‚´ìš©ì„ ìˆ˜ì •í•´ì£¼ì„¸ìš”"/>
	        <button type="submit" id="completeBtn" onclick="reviseItem()">ì™„ë£Œ</button>
	    </div>
	</div>
	-->
	

<!-- Bootstrap JS -->
<script th:src="@{/bootstrap.min.js}"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script>

let value = "";

function deleteItem(id){
	if(confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
		console.log(id)
		    const url = "/todo/delete/"+id
		    $.ajax({
		        type:'delete',
		        url:url,
		        contentType:'application/json; charset=utf-8'
		        }).done(function() {
		        //alert('í•  ì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
		        window.location.href = '/todo/list';
		        }).fail(function (error){
		        alert(JSON.stringify(error));
		    });
	} else {
		//  ì‚­ì œ ì·¨ì†Œ
		console.log('ì‚­ì œ ì·¨ì†Œ');
	}
    
}


function openModal(id) {
    value = id; // ìˆ˜ì •í•  í•­ëª© ID ì €ì¥
    const currentContent = document.querySelector(`a[th:href='|/todo/detail/${id}|']`).textContent; // í˜„ì¬ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
    document.getElementById("reviseInput").value = currentContent; // ëª¨ë‹¬ì˜ inputì— í˜„ì¬ ë‚´ìš© í‘œì‹œ
}

function reviseItem() {
    const id = value; // ì €ì¥ëœ ID ê°€ì ¸ì˜¤ê¸°
    const updateContent = document.getElementById("reviseInput").value; // ì…ë ¥í•œ ìˆ˜ì • ë‚´ìš© ê°€ì ¸ì˜¤ê¸°

    if (confirm('ì •ë§ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        const url = "/todo/update/" + id;
        $.ajax({
            type: 'put',
            url: url,
            contentType: 'application/json; charset=utf-8',
            data: updateContent,
        }).done(function() {
            //alert('í•  ì¼ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.location.href = '/todo/list';
        }).fail(function(error) {
            alert(JSON.stringify(error));
        });

        // ëª¨ë‹¬ ë‹«ê¸°
        $('#reviseModal').modal('hide');
    } else {
        console.log('ìˆ˜ì • ì·¨ì†Œ');
    }
}

function completeItem(id, isChecked) {
    console.log(`Item ID : ${id}, Checked: ${isChecked}`);
    const url = `/todo/complete/${id}`;
	
	if(isChecked) {
		$.ajax({
	        type:'put',
	        url:url,
	        contentType:'application/json; charset=utf-8'
	    }).done(function() {
	    	//alert('í•  ì¼ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!');
	        window.location.href = '/todo/list';
	    }).fail(function (error){
	        alert(JSON.stringify(error));
        });	
	} else {
		$.ajax({
		    type:'put',
		    url:url,
		    contentType:'application/json; charset=utf-8'
		}).done(function() {
			//alert('í•  ì¼ì˜ ì™„ë£Œë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.');
		    window.location.href = '/todo/list';
		}).fail(function (error){
		    alert(JSON.stringify(error));
		});
		
	}
     
}

function togglePriority(id) {
    const url = `/todo/priority/${id}`;
    $.ajax({
        type: 'put',
        url: url,
        contentType: 'application/json; charset=utf-8',
    }).done(function() {
        // ìš”ì²­ ì„±ê³µ ì‹œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
        window.location.reload();
    }).fail(function(error) {
        alert(JSON.stringify(error));
    });
}

</script>
</html>